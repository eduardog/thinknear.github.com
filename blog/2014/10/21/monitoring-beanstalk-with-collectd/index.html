

<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Monitoring Beanstalk With Collectd - Thinknear Engineering</title>
  <meta name="author" content="Thinknear by Telenav">

  
  <meta name="description" content="Our system Thinknear&rsquo;s Real Time Bidding service is built on AWS Elastic Beanstalk.
We run around one-hundred instances to serve billions of &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://engineering.thinknear.com/blog/2014/10/21/monitoring-beanstalk-with-collectd">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Thinknear Engineering" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>


  <body   >

    <header role="banner">
      <nav role="navigation">
        <div class="container">
  <a href="/"><img src="/images/thinknear_engineering_logo.png" alt="Thinknear Engineering" /></a>
  <ul class="subscription" data-subscription="rss">
    <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
    
  </ul>
    
  <form action="https://www.google.com/search" method="get">
    <fieldset role="search">
      <input type="hidden" name="q" value="site:engineering.thinknear.com" />
      <input class="search" type="text" name="q" results="0" placeholder="Search"/>
    </fieldset>
  </form>
    
  <ul class="main-navigation">
  <li><a href="//www.thinknear.com">Thinknear</a></li>
  <li><a href="/values">About Us</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="//www.thinknear.com/career">Careers</a></li>
</ul>

</div>

      </nav>

      <hgroup>
<!-- <h1><a href="/">Thinknear Engineering</a></h1> -->
  <h1>
    <a href="/">
      <img src="/images/thinknear_engineering_logo_pin.png" alt="Thinknear Engineering" />
    </a>
    Thinknear Engineering
  </h1>
  
    <h2>Big Data, High Frequency</h2>
  
</hgroup>


    </header>

    <div id="main">
      <div id="content">
        <div>
  <article class="hentry" role="article">
    
  <header>
    
      <h1 class="entry-title">Monitoring Beanstalk With Collectd</h1>
    

    
      <p class="meta">
        
  








    <time class='entry-date' datetime='2014-10-21T17:51:02-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span></time>
  
        
      </p>
    
  </header>



  <div class="entry-content"><h2>Our system</h2>

<p>Thinknear&rsquo;s <a href="http://en.wikipedia.org/wiki/Real-time_bidding">Real Time Bidding</a> service is built on <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/Welcome.html">AWS Elastic Beanstalk</a>.
We run around one-hundred instances to serve billions of auctions a day.
The system must be highly available, performant and maintain high success rates.
Operationally, engineers must be able to ship code throughout the week and change configurations without disrupting service.
We make data driven decisions to meet these standards by using metrics gathering systems like <a href="https://collectd.org/">collectd</a>.</p>

<blockquote><p>If you don&rsquo;t know where you are going, you&rsquo;ll end up someplace else &ndash; Yogi Berra</p></blockquote>

<p>If you run your services in the cloud, then you know there is a risk of overpaying.
There are a lot of factors that go into your cloudâ€™s cost.
For example, we want to know when:</p>

<ul>
<li>We are under-utilizing instances.</li>
<li>Hosts are suffering from <a href="http://blog.scoutapp.com/articles/2013/07/25/understanding-cpu-steal-time-when-should-you-be-worried">steal time</a>.</li>
<li>We need a instance type that better suits our needs.</li>
</ul>


<p>Tracking memory, CPU and network statistics are key to meeting these goals and making sound decisions.
But we don&rsquo;t stop there.
There are multitudes of metrics to track.</p>

<!-- more -->


<h2>Measure everything</h2>

<p>At the instance level, AWS EC2 CloudWatch metrics from a Beanstalk environment didn&rsquo;t meet our needs.
CloudWatch provides CPU, Disk IO and Network IO; however, it lacks load, memory, fine-grained configurations and a method to extend the set of collected metrics.
Our engineering team needs more.
That is why we are users of the rock-solid statistics collection daemon collectd.</p>

<p>Collectd can track any system metric we want &ndash; the <a href="https://collectd.org/wiki/index.php/Table_of_Plugins">official plugins list</a> is extensive.
It works as a daemon running a loop over a set of plugins.
There is no graphing built into collectd so one must be configured.
<a href="http://graphite.readthedocs.org/en/1.0/tools.html">Graphite</a> is a popular frontend &ndash; but it only does graphing.
We like <a href="https://metrics.librato.com/">Librato</a>, a paid service, which has beautiful graphs, aggregates metrics and provides alerting similar to CloudWatch.</p>

<blockquote><p>Do not look where you fell, but where you slipped &ndash; African proverb</p></blockquote>

<p>We use collectd to track memory, load, cpu, network, JVM, process statistics and more.
Every Beanstalk host is deployed with a collectd installation as a standalone metric collector and reporter that is configured.
It is configured to report to Librato every minute.
This gives us the detailed performance tracking and a monitor for unexpected events.
When things go wrong, we can see what, when and how often an event happened.
When we make instance type changes, we can see exactly how we use system resources we need for each host.</p>

<h2>Getting started with Elastic Beanstalk and collectd</h2>

<p>Setting up collectd with Beanstalk is easy.
Below is a simple <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/customize-containers-ec2.html">Elastic Beanstalk configuration</a> that will:</p>

<ol>
<li>Install collectd on your instances.</li>
<li>Create a basic collectd configuration file for collecting CPU, network IO, load and memory statistics.
It uses the write_http plugin to report to Librato.</li>
<li>Start and supervise collectd daemon with the collectdmon monitor process.
There are alternatives like <a href="http://mmonit.com/monit/">monit</a>, but we like collectdmon because it is installed with the collectd package.</li>
</ol>


<p>This configuration was tested on a 2014.03 Amazon Linux EC2 instance.
This version of Amazon Linux comes with <a href="http://aws.amazon.com/amazon-linux-ami/2014.03-packages/">collectd-5.4.1</a> as an available RPM package.</p>

<p>Put this file into your project&rsquo;s <code>.ebextensions</code> directory.
Replace the <code>User</code> and <code>Password</code> fields with your credentials.</p>

<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># .ebextensions/collectd.config</span>
</span><span class='line'><span class="l-Scalar-Plain">files</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="s">&quot;/etc/collectd.conf&quot;</span> <span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">mode</span><span class="p-Indicator">:</span> <span class="s">&quot;000664&quot;</span>
</span><span class='line'>    <span class="l-Scalar-Plain">owner</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
</span><span class='line'>    <span class="l-Scalar-Plain">group</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">root</span>
</span><span class='line'>    <span class="l-Scalar-Plain">content</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'>      <span class="no">LoadPlugin syslog</span>
</span><span class='line'>      <span class="no">LoadPlugin cpu</span>
</span><span class='line'>      <span class="no">LoadPlugin interface</span>
</span><span class='line'>      <span class="no">LoadPlugin load</span>
</span><span class='line'>      <span class="no">LoadPlugin memory</span>
</span><span class='line'>      <span class="no">LoadPlugin write_http</span>
</span><span class='line'>      <span class="no">&lt;Plugin write_http&gt;</span>
</span><span class='line'>        <span class="no">&lt;URL &quot;https://collectd.librato.com/v1/measurements&quot;&gt;</span>
</span><span class='line'>          <span class="no">User &quot;user@example.com&quot;</span>
</span><span class='line'>          <span class="no">Password &quot;password&quot;</span>
</span><span class='line'>          <span class="no">Format &quot;JSON&quot;</span>
</span><span class='line'>        <span class="no">&lt;/URL&gt;</span>
</span><span class='line'>      <span class="no">&lt;/Plugin&gt;</span>
</span><span class='line'>      <span class="no">Include &quot;/etc/collectd.d&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">packages</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">yum</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">collectd</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">commands</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">start_collectd</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">killall collectd; collectdmon -c collectd</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>


<p>Collectd will start reporting metrics to Librato when you deploy your application.</p>

<p>Then you can start building Librato instruments and dashboards that look like this:</p>

<p><img src="/images/collectd_cpu.png" alt="collectd CPU" /></p>

<p><img src="/images/collectd_dash.png" alt="collectd dash" /></p>

<h2>Summary</h2>

<p>At Thinknear, we strive to measure anything that will help us understand the behavior of our systems in production.
Collectd is a great tool for us to track instance level statistics that CloudWatch does not provide.</p>
</div>


    <footer>
      <p class="meta">
        
  

<span class="byline author vcard">Posted by <span class="fn">Thinknear by Telenav</span></span>

        
  








    <time class='entry-date' datetime='2014-10-21T17:51:02-07:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>21</span><span class='date-suffix'>st</span>, <span class='date-year'>2014</span></span></time>
  
        


      </p>
      
        <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://engineering.thinknear.com/blog/2014/10/21/monitoring-beanstalk-with-collectd/" data-via="ThinknearEng" data-counturl="http://engineering.thinknear.com/blog/2014/10/21/monitoring-beanstalk-with-collectd/" >Tweet</a>
  
  
  
</div>

      
      <p class="meta">
        
          <a class="basic-alignment left" href="/blog/2014/08/22/unnecessary-complexity/" title="Previous Post: Unnecessary Complexity">&laquo; Unnecessary Complexity</a>
        
        
          <a class="basic-alignment right" href="/blog/2014/11/11/tn-s3-file-uploader-released/" title="Next Post: tn_s3_file_uploader released">tn_s3_file_uploader released &raquo;</a>
        
      </p>
    </footer>
  </article>
  
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
  
</div>

  <aside class="sidebar">
    
      <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/30/rails-migration-and-dependencies-on-user-defined-tables-slash-views/">Rails Migration and Dependencies on User Defined Tables/Views</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/03/09/interviewing-with-thinknear/">Interviewing With Thinknear</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/21/understanding-the-decision-to-move-from-aws-emr-slash-hive-to-redshift/">Understanding the Decision to Move From AWS EMR/Hive to Redshift</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/07/advanced-angular-ui-router-part-i/">Advanced Angular UI Router Part I: Nested Views</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/06/heroku-cost-savings-using-generic-workers/">Heroku Cost Optimization Using Generic Workers</a>
      </li>
    
  </ul>
</section>





    
  </aside>


      </div>
    </div>

    <footer role="contentinfo">
      <p>
  Copyright &copy; 2015 - Thinknear by Telenav -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>


    </footer>

    

<script type="text/javascript">
      var disqus_shortname = 'thinknearengineering';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://engineering.thinknear.com/blog/2014/10/21/monitoring-beanstalk-with-collectd/';
        var disqus_url = 'http://engineering.thinknear.com/blog/2014/10/21/monitoring-beanstalk-with-collectd/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






  </body>
</html>
